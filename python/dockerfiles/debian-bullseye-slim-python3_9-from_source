# NOTE!
# The COPY command will only work properly if
# the command using this Dockerfile to build the Docker image
# is called from the
# save-thread-result/python directory
# and will NOT work if called from the
# save-thread-result/python/tests directory
# or the
# save-thread-result directory


FROM debian:bullseye-20231120-slim AS base

RUN set -eux; \
  savedAptMark="$(apt-mark showmanual)"; \
  apt-get -y update; apt-get install \
  curl \
  gcc \
  make \
  gdb lcov pkg-config \
      libbz2-dev libffi-dev libgdbm-dev libgdbm-compat-dev liblzma-dev \
      libncurses5-dev libreadline6-dev libsqlite3-dev libssl-dev \
      lzma lzma-dev tk-dev uuid-dev zlib1g-dev -y \
  && curl -SL https://www.python.org/ftp/python/3.9.18/Python-3.9.18.tgz | tar -xzvf - \
  && cd Python-3.9.18 && ./configure --with-lto && make -j $(nproc) && make install \
  && cd / \
  && rm -rf Python-3.9.18 \
  && find /usr/local -depth \
		\( \
			\( -type d -a \( -name test -o -name tests -o -name idle_test \) \) \
			-o \( -type f -a \( -name '*.pyc' -o -name '*.pyo' -o -name 'libpython*.a' \) \) \
		\) -exec rm -rf '{}' + \
	; \
  apt-mark auto '.*' > /dev/null; \
	# apt-mark manual $savedAptMark; \
  find /usr/local -type f -executable -not \( -name '*tkinter*' \) -exec ldd '{}' ';' \
		| awk '/=>/ { so = $(NF-1); if (index(so, "/usr/local/") == 1) { next }; gsub("^/(usr/)?", "", so); printf "*%s\n", so }' \
		| sort -u \
		| xargs -r dpkg-query --search \
		| cut -d: -f1 \
		| sort -u \
		| xargs -r apt-mark manual \
	; \
  apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \
  rm -rf /var/lib/apt/lists/*

FROM debian:bullseye-20231120-slim AS final

COPY --from=base /usr/local/ /usr/local/

COPY . ./save_thread_result/python

CMD ["python3.9", "save_thread_result/python/dummy_example.py"]
